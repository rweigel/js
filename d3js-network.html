<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
		<title>WPMS Network</title>
		
		<link rel="icon" type="image/ico" href="css/favicon.ico"/>		
		<link rel="stylesheet" type="text/css" href="d3js-network.css">
		<script src="d3js-network.js"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
	</head>

	<body>

	<script>
		// npm install http-server -g
		// http-server
		// http://bl.ocks.org/mbostock/4063550
		var server  = "http://onair.cc/"
		var network = "?oaapi=get&the=network";
		var users   = "?oaapi=get&the=users";
		var sites   = "?oaapi=get&the=sites";

		$.getJSON("onair.cc.network.json", function (data) {
			// obj = {name:"",link:"",children:[obj1,obj2,...]}
			console.log(data);
			var json = {};
			json["name"] = data["site_name"];
			json["link"] = data["site_url"];
			json["children"] = [];
			var sn = data["site_network"];
			$.each(sn, function (i,obj) {
				json.children[i] = {};
				json.children[i]["name"]     = obj.user_name;
				json.children[i]["link"]     = "http://" + obj.user_name + ".onair.cc";
				json.children[i]["type"]     = "user";

				json.children[i]["children"] = [];
					$.each(obj["member_of"], function (j,obj2) {
						//console.log(j)
						json.children[i]["children"][j] = {};
						json.children[i]["children"][j]["name"] = obj2["site_name"];
						json.children[i]["children"][j]["link"] = obj2["site_url"];
						json.children[i]["children"][j]["type"] = "site";
					});

			});

			console.log(json)

			drawcircular(json);

		})

		function drawcircular(json) {
			// Based on http://bl.ocks.org/mbostock/4063550
			var diameter = 1060;

			var tree = d3.layout.tree()
				.size([360, diameter / 2 - 120])
				.separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

			var diagonal = d3.svg.diagonal.radial()
										.projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });

			var svg = d3.select("body").append("svg")
				.attr("width", diameter)
				.attr("height", diameter)
				.append("g")
				.attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")");

			var nodes = tree.nodes(json);
			var links = tree.links(nodes);

			var link = svg.selectAll(".link")
							.data(links)
							.enter().append("path")
							.attr("class", "link")
							.attr("d", diagonal);

			var node = svg.selectAll(".node")
							.data(nodes)
							.enter().append("g")
							.attr("class", "node")
							.attr("transform",
									function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

			//node.append("circle").attr("r", 4.5);
			node.append("circle").attr("r", 4.5);

			node.append("a")
				.attr('xlink:href',function(d) { return d.link})
				.append("text")
					.attr("dy", ".31em")
					.attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
					.attr("transform", function(d) { return d.x < 180 ? "translate(8)" : "rotate(180)translate(-8)"; })
					.text(function(d) { return d.name; });

			d3.select(self.frameElement).style("height", diameter - 150 + "px");
			
		}

		function drawcartesian(json) {
			// Based on http://bl.ocks.org/mbostock/4339184
			var width = 960;
			var height = 900;

			var tree = d3.layout.tree().size([height, width - 160]);

			var diagonal = d3.svg.diagonal().projection(function(d) { return [d.y, d.x]; });

			var svg = d3.select("body")
						.append("svg")
						.attr("width", width)
						.attr("height", height)
						.append("g")
						.attr("transform", "translate(40,0)");

			var nodes = tree.nodes(json);
			var links = tree.links(nodes);
			
			var link  = svg.selectAll("path.link")
							.data(links)
							.enter()
							.append("path")
							.attr("class", "link")
							.attr("d", diagonal);

			var node  = svg.selectAll("g.node")
							.data(nodes)
							.enter()
							.append("g")
							.attr("class", function () {d.type + " node"})
							.attr("transform",
									function(d) { return "translate(" + d.y + "," + d.x + ")"; });

			node.append(function(d) {return "circle"}).attr("r", 4.5);

			node.append("a")
				.attr('xlink:href',function(d) { return d.link}).append("text")
				.attr("dx", function(d) { return d.children ? -8 : 8; })
				.attr("dy", 3)
				.attr("text-anchor", function(d) { return d.children ? "end" : "start"; })
				.text(function(d) { return d.name; });

			d3.select(self.frameElement).style("height", height + "px");
		}

	</script>